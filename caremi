#!/usr/bin/env php
<?php

// Set base path
define('BASE_PATH', __DIR__);

// Autoload
require_once BASE_PATH . '/vendor/autoload.php';

// Bootstrap the container
/** @var \Psr\Container\ContainerInterface $container */
$container = require BASE_PATH . '/config/container.php';

// Get input command
$input = $argv[1] ?? null;

if (!$input) {
    echo "Usage: php caremi [command] [--options]" . PHP_EOL;
    exit(1);
}

// Get the Kernel
$kernel = $container->get(\Careminate\Console\Kernel::class);

// Let Kernel attempt to handle the command
$status = $kernel->handle($argv);

// If the Kernel returned a status other than null, exit
if ($status !== null) {
    exit($status);
}

// Otherwise, fallback to the legacy static command registry
$commands = require BASE_PATH . '/config/console.php';

if (!isset($commands[$input])) {
    echo "Command [$input] not found." . PHP_EOL;
    exit(1);
}

$commandClass = $commands[$input];
$command = new $commandClass();

if (!method_exists($command, 'handle')) {
    echo "Command [$input] does not have a handle() method." . PHP_EOL;
    exit(1);
}

// Pass remaining arguments
$args = array_slice($argv, 2);
$status = $command->handle($args);

exit(is_int($status) ? $status : 0);



 